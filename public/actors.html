<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Cinematography</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrender/1.0.12/jsrender.min.js"integrity="sha512-0IE+tamZ/+AIGOdEJQWN32ogflnKTCC1eRi3NC3lqf7FhfmwzONIg2r3lsQJUTgAYmgtYOsihuw6jjt7adAJ7Q=="crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/picnic">
  <link rel="stylesheet" href="stylesheets/css.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-serialize-object/2.5.0/jquery.serialize-object.min.js"integrity="sha512-Gn0tSSjkIGAkaZQWjx3Ctl/0dVJuTmjW/f9QyB302kFjU4uTNP4HtA32U2qXs/TRlEsK5CoEqMEMs7LnzLOBsA=="crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-serialize-object/2.5.0/jquery.serialize-object.min.js" integrity="sha512-Gn0tSSjkIGAkaZQWjx3Ctl/0dVJuTmjW/f9QyB302kFjU4uTNP4HtA32U2qXs/TRlEsK5CoEqMEMs7LnzLOBsA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/navigo/8.11.1/navigo.min.js" referrerpolicy="no-referrer"></script>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Cinematography</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="./index.html">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="./films.html">Films</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="./actors.html">Actors</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="./contactForm.html">Contact</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="./about.html">About me</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
<script id="modify_actor_template" type="text/x-handlebars-template">
  <h1>Modify Actor</h1>
  <form id="modify_actor_form">

    <label for="name">Name</label>
    <input type="text" id="name" name="name" value="{{:actor.name}}">
    <br>
    <label for="cast">Cast</label>
  <select name="cast">
  {{for films.films}}
    <option value="{{:id}}">{{:name}}</option>
  {{/for}}
  </select>
    <!-- No queremos que el usuario introduzca el id del grupo para insertarlo.
    Le popondremos un listado de los nombres de peliculas disponibles con un select.
     Para ello habrá que pasar ese listado de peliculas de films al template-->
    <label for="birth_date">Birth Date</label>
    <input type="text" id="birth_date" name="birth_date"{{:actor.birth_date}}>
    <br>
    <label for="year_of_death">Year of Death</label>
    <input type="text" id="year_of_death" name="year_of_death"{{:actor.year_of_death}}>
    <br>
    <label for="img">Image</label>
    <input type="text" id="img" name="img" value="{{:actor.img}}">
    <br>
    <input id="modifyActorSumbit" type="submit" value="Modificar" data-id="{{:actor.id}}">
  </form>
</script>


<script id="add_actor_template" type="text/x-handlebars-template">
  <h1>Insert Actor</h1>
  <form id="add_actor_form">
    <label for="name">Name</label>
    <input type="text" id="name" name="name">
    <br>

    <label for="cast">Cast</label>
  <select name="cast">
  {{for films}}
    <option value="{{:id}}">{{:name}}</option>
  {{/for}}
  </select>
    <br>
    <!-- No queremos que el usuario introduzca el id del grupo para insertarlo.
    Le popondremos un listado de los nombres de peliculas disponibles con un select.
     Para ello habrá que pasar ese listado de peliculas de films al template-->
    <label for="birth_date">Birth Date</label>
    <input type="text" id="birth_date" name="birth_date">

    <br>
    <label for="year_of_death">Year of Death</label>
    <input type="text" id="year_of_death" name="year_of_death">
    <br>
    <label for="nationality">Nationality</label>
    <input type="text" id="nationality" name="nationality">
    <br>
    <label for="years_active">Years Active</label>
    <input type="text" id="years_active" name="years_active">
    <br>
    <label for="img">Image</label>
    <input type="text" id="img" name="img">
    <br>
    <input type="submit" id="submit_add_actors_form">
  </form>
</script>

<div class="titulo">
  <h1>Actors</h1>
</div>
<script id="actors_template" type="text/x-handlebars-template">

  <!-- La ruta para addActors se construye en el enlace
  La direccion de salto (href) es relativa a este documento
  y debe SIEMPRE empezar por hash #-->
  <a href="#/add" class="btn btn-primary">Add</a>
  <br>
  <br>


  <table class="table table-bordered table-dark">

    <thead>
    <tr>
      <th scope="row">Name</th>
      <th scope="row">Cast</th>
      <th scope="row">Birth Date</th>
      <th scope="row">Year of Death</th>
      <th scope="row">Nationality</th>
      <th scope="row">Years Active</th>
      <th scope="row">Image</th>
      <th scope="row">Actions</th>
    </tr>
    </thead>
    <tbody>
    {{for actors}}
    <tr>
      <td>{{:name}}</td>
      <td>{{:cast}}</td>
      <td>{{:birth_date}}</td>
      <td>{{:year_of_death}}</td>
      <td>{{:nationality}}</td>
      <td>{{:years_active}}</td>
      <td><img class="imagen" src="{{:img}}"</td>
      <td>
        <!-- hrefs="#" indica que el salto será a la pagina actual -->
        <!-- data-id="444" envia junto con el evento el valor id="444" -->
        <a href="#/modify?id={{:id}}" class="btn btn-warning">Modify</a><br>
        <a href="#/delete?id={{:id}}" class="btn btn-danger">Delete</a>
      </td>
    </tr>
    </tbody>
  {{/for}}
  </table>
</script>


<div id="app"></div>


<script>

  // Creacion del router como una constante
  const router = new Navigo('/', {hash: true})
  // Se definen las rutas
      router
          .on('/',showActors)
          .on('/actors.html',showActors)
          .on('/add',addActor)
          .on('/modify', showModifyActorForm)
          .on('/delete',deleteActor)
          .resolve();

  function getModifyActorFormParams(event){
    event.preventDefault();
    // Se toma el formulario a partir de su id
    let form =$('#modify_actor_form')
    // se toman los parametros pero con form.serialize()
    // se obtienen en formato GET y los queremos en formato POST
    //let parameters = form.serialize();
    //se necesita la biblioteca jquery.serializeObject() para obtenerlos en formato JSON
    let parameters = form.serializeObject();
    console.log(parameters)

    //se recoge el id del album del parametro data-id del submit
    let id = $(this).data("id");
    //se llama a la api con POST
    $.post('/api/actors/' + id, parameters,function (data){
      // si todo ha ido bien se muestran los resultados
      showActors()
    }).catch(function (error){
      console.log(error)
    });
  }
  function showModifyActorForm(params) {
    let id = params.params.id;

     $.getJSON('/api/actors/' + id , function (dataActor){
      //ahora se piden los datos de todos los actores puesto que queremos que escoger entre ellos
      //y no queremos utilizar ids
      $.getJSON('/api/films/', function (dataFilms){
        console.log(dataFilms)
        //como dataFilms es una lista pero queremos el primer elemento
        console.log(dataActor)
        let actor = dataActor.actors[0]

        //construimos un objeto JSON para pasarlo al template al renderizarlo
        let data={
          'actor':actor,
          'films':dataFilms
        }
        console.log(data.films.films)
        // ahora se renderiza el template
        //ahora hay que crear el template de modificar a partir del template de insertar
        let html = $("#modify_actor_template").render(data);
        $("#app").html(html);

        //se pone el event handler del sumbit a partir del class del boton submit
        $('#modifyActorSumbit').on('click', getModifyActorFormParams)
      });
    });

  }


  function showActors() {
    //llamada asicrona a la API
    $.getJSON('/api/actors/', function (data) {
      //ver resultado
      console.log(data);
      //Con los resultados se renderiza el template
      let html = $('#actors_template').render(data);
      //inyectar datos
      $("#app").html(html);
      //Se seleccionan todos los elemntos con class 'delete'
    }).catch(function (error){
      console.log(error)
    });
  }

  function deleteActor(params) {
    //No queremos,que el click nos lleve a ningun sitio
    // se "previene" el comportamiento por defecto que ir donde apunta href
    //se recoge el id del elemnto sobre el que se hizo click
    //$(this)no devuelve esta funcion
    // data son los datos que transporta el evento con el campo data-id
    let id = params.params.id;
    // Ahora llamaremos a la API para borrar el elemnto 'id'
    // Haremos una llamada asíncrona con jquery
    // Se utiliza la misma URL que mostrar films
    // pero el tipo de peticion HTTP no es GET y no es POST
    // es DELETE
    $.ajax({
      url: '/api/actors/' + id,
      type: 'DELETE'
    })
            // Si todo ha ido bien se vuelve a mostrar la lista de films
            .then(function (result) {
              router.navigate('/')
            })
            // SI hay error se saca por consola
            .catch(function (error) {
              console.log(error)
            })
  }

  function addActorForm(event) {
    event.preventDefault();
    <!-- Se recogen los parametros desde form -->
    let form = $("#add_actor_form");

    //Pero estos parametros estan en formato GET
    //Para tenerlos en formato JSON hay que utilizar
    // jquery-serialize-object
    let parametros = form.serializeObject();
    //console.log(parametros);
    //console.log('Se recogen los parametros desde el form');
    //Ahora se envian con HTTP POST a la API
    $.post('/api/actors/', parametros, function (result) {
      //Si todo ha ido bien se vuelve a mostrar la lista de actores
      //es decir se vuelve a la raiz del documento
      router.navigate('/')
    }).catch(function (error) {
      console.log(error)
    });
  }

  function addActor() {
    $.getJSON('/api/films/', function (films) {
      let html = $("#add_actor_template").render(films);
      $("#app").html(html);
      $("#submit_add_actors_form").on("click", addActorForm);

    });
  }


  // un poco de refactoring
  //Se llama a la funcion ready del doucmento para ponerlo todo alli dentro
  //Esta funcion se ejecuta SOLO cuando todo el documento esta listo
  $(document).ready(function () {
    //showActors();
    // La ruta raiz / es relativa a este documento, es decir a actors.html
    router.navigate('/')
  });


</script>
</body>
</html>